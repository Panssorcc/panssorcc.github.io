---
layout: post
title: "MongoDB和Mongoose"
subtitle: ''
date:   2019-08-15 17:00:26 +0800
author: "Pcc"
header-img: "img/pcc_time.jpg"
header-mask: 0.3
tags:

  - MongoDB
---

## MongoDB

### 安装mongoDB

[安装链接](https://www.runoob.com/mongodb/mongodb-window-install.html)

![环境变量配置](https://raw.githubusercontent.com/Panssorcc/picee/master/images/node-mongoDB%E5%AE%89%E8%A3%85.png)



### 使用mongoDB

- 那么我们就能在系统的任何盘符，使用mongo命令了：

> mongo   使用数据库

> mongod  开机

> mongoimport  导入数据

- 开机命令：`mongod --dbpath c:\mongo`

- 管理数据库：`mongo`  (一定要在新的cmd中输入)

- 那么，运行环境就是mongo语法:

  > 列出所有数据库：`show dbs `

  > 使用某个数据库：`use 数据库名字`（如果想新建数据库，也是use。use一个不存在的，就是新建。）

  > 查看当前所在数据库： `db`

![mongo语法](https://raw.githubusercontent.com/Panssorcc/picee/master/images/node-mongoDB%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.png)

- `db.student.insert({“name”:”xiaoming”});`

  `student`就是所谓的集合。集合中存储着很多json。

- 删除数据库，删除当前所在的数据库
  `db.dropDatabase();`

### **1、插入数据**insert()

- 插入数据，随着数据的插入，数据库创建成功了，集合也创建成功了。
  `db.student.insert({"name":"xiaoming"});`
- 我们不可能一条一条的insert。所以，我们希望用sublime在外部写好数据库的形式，然后导入数据库：

`mongoimport --db test --collection restaurants --drop --file primer-dataset.json`

> --db test  想往哪个数据库里面导入
> --collection restaurants  想往哪个集合中导入
> --drop 把集合清空
> --file primer-dataset.json  哪个文件

- 这样，我们就能用sublime创建一个json文件，然后用mongoimport命令导入，这样学习数据库非常方便。

  ![](https://raw.githubusercontent.com/Panssorcc/picee/master/images/node-mongoDB-%E5%AF%BC%E5%85%A5json%E6%96%87%E4%BB%B6.png)

### **2、查找数据**find()

查找数据，用find。find中没有参数，那么将列出这个集合的所有文档：

`db.restaurants.find()`

![示例](https://raw.githubusercontent.com/Panssorcc/picee/master/images/node-mongoDB-json%E6%96%87%E4%BB%B6%E7%A4%BA%E4%BE%8B.png)

- 精确匹配：score是json，shuxue是key

  `db.student.find({"score.shuxue":70});`

  

- 多个条件：

  `db.student.find({"score.shuxue":70 , "age":12})`

  

- **{ $gt：数字 }**大于条件：

  db.student.find({"score.yuwen":**{$gt:50}**});

  

- **{$or :  [{},{}]  }** 或者。寻找所有年龄是9岁，或者11岁的学生 

  db.student.find({**$or**:[{"age":9},{"age":11}]});

  

- 查找完毕之后，打点调用sort，表示升降排序。(**sort**)

  db.restaurants.find().**sort(** { "borough": 1, "address.zipcode": 1 } )

  > 1代表升序，-1代表降序

### **3、修改数据**update()

修改里面还有查询条件。你要该谁，要告诉mongo。

- 查找名字叫做小明的，把年龄更改为16岁:

  `db.student.update({"name":"小明"},{$set:{"age":16}});`

- 查找数学成绩是70，把年龄更改为33岁：

  `db.student.update({"socre.shuxue":70},{$set:{"age":33}});`

 

- 更改所有匹配项目：**{multi: true}**

- **multi** : 可选，mongodb 默认是false,只更新找到的第一条记录，如果这个参数为true,就把按条件查出来多条记录全部更新

  `db.student.update({"sex":"男"},{$set:{"age":33}},{multi: true});`



- 完整替换，不出现$set关键字了：

  `db.student.update({"name":"小明"},{"name":"大明","age":16});`



### **4、 删除数据remove()**

 

`db.restaurants.remove( { "borough": "Manhattan" } )`



- By default, the remove() method removes all documents that match the remove condition. Use the justOne option to limit the remove operation to only one of the matching documents.(下面删除一个 `{ justOne: true }` )

​      ` db.restaurants.remove( { "borough": "Queens" }, { justOne: true } )` 





## node操作**Mongoose**

Mongoose是一个将JavaScript对象与数据库产生关系的一个框架，object related model。操作对象，就是操作数据库了；对象产生了，同时也持久化了。

[官网](http://mongoosejs.com/)

示例：

```javascript
//引包，并不需要引用mongodb这个包
var mongoose = require('mongoose');
//链接数据库,haha是数据库名字
mongoose.connect('mongodb://localhost/haha');

//创建了一个模型。猫的模型。所有的猫，都有名字，是字符串。“类”。
var Cat = mongoose.model('Cat', { name: String });
//实例化一只猫
var kitty = new Cat({ name: 'Zildjian' });
//调用这只猫的save方法，保存这只猫
kitty.save(function (err) {
  console.log('喵喵喵');
});

var tom = new Cat({"name":"汤姆"});
tom.save(function(){
	console.log('喵喵喵');
});

```

上面的代码中，没有一个语句是明显的操作数据库，感觉都在创建类、实例化类、调用类的方法。都在操作对象，但是数据库同步被持久了。

mongoose的哲学，就是让你用操作对象的方式操作数据库。

+ 创建一个模型
  `mongoose.model("Cat",{"name" : String , "age" : Integer}); `
+ 就可以被实例化
  `var kitty = new Cat({ name: 'Zildjian' });`
  然后这个实例就可以被save。

+ mongoose首先要想明白一件事儿，所有的操作都不是对数据库进行的。所有的操作都是对类、实例进行的。但是数据库的持久化自动完成了。

### **1、数据库连接**

公式：
```javascript
var mongoose = require('mongoose');
//创建数据库连接
var db      = mongoose.createConnection('mongodb://127.0.0.1:27017/haha');
//监听open事件
db.once('open', function (callback) {
    console.log("数据库成功连接");
});
```


### **2、定义模型**

**创造schema → 定义一些schema的静态方法 → 创造模型**

创造schema用什么语句？ ` new mongoose.schema({});`

创造模型用什么语句？ 	`db.model(“Student”,schema名字);`

 ```javascript
//创建了一个schema结构。
var studentSchema = new mongoose.Schema({
    name     :  {type : String},
    age      :  {type : Number},
    sex      :  {type : String}
});
//创建静态方法
studentSchema.statics.zhaoren = function(name, callback) {
    this.model('Student').find({name: name}, callback);   //this.model('Student')指的是当前这个类
};
//创建修改的静态方法
studentSchema.statics.xiugai = function(conditions,update,options,callback){
    this.model("Student").update(conditions, update, options, callback);
}
//创建了一个模型，就是学生模型，就是学生类。
//类是基于schema创建的。
var studentModel = db.model('Student', studentSchema);
 ```

 

解释一下，什么是静态方法，什么是类方法：

```javascript
//类
function Student(){
	
}

//实例化一个学生
var xiaoming = new Student();
//实例方法，因为这个sleep方法的执行者是类的实例
xiaoming.sleep();


//静态方法（类方法），这个方法的执行者是这个类，不是这个类的实例。
Student.findAllBuJiGe();
```

前台界面：不操作数据库，只操作类！