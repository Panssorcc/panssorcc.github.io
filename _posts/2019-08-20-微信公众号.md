## **微信公众号开发**

![微信公众号接入](https://raw.githubusercontent.com/Panssorcc/picee/master/images/node-%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7-%E6%8E%A5%E5%85%A5_2019-09-16_11-13-20.png)

![验证公众号](https://raw.githubusercontent.com/Panssorcc/picee/master/images/node-%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7-%E9%AA%8C%E8%AF%81_2019-09-16_11-13-20.png)

### **安装`ngrok`**（内网穿透）

[官网](https://ngrok.com/download)

1. 下载ngrok客户端

2. 本地启动服务器，如http://localhost:8888，端口号为8888

3. 打开ngrok客户端，输入ngrok http 1234，启动内网穿透

4. 复制生成后的网址

5. ![配置](https://raw.githubusercontent.com/Panssorcc/picee/master/images/node-%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7-%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF_2019-09-16_11-13-20.png)

   ![启动内网穿透](https://raw.githubusercontent.com/Panssorcc/picee/master/images/node-%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7-ngrok%E5%90%AF%E5%8A%A8_2019-09-16_11-13-20.png)

### 验证服务器地址的有效性

   + `app.js`部分：

   1）将token、timestamp、nonce三个参数进行字典序排序 
   2）将三个参数字符串拼接成一个字符串进行sha1加密 
   3）开发者获得加密后的字符串可与signature对比，标识该请求来源于微信

```javascript
var express=require('express');
var sha1=require('sha1');
const app =express();

const config = {
    wechat: {
      appId: 'XXXXXXXXX',
      appsecret: '*****************************************',
      token: 'Cc123456789'
    }
  }
app.use((req,res,next)=>{

    // console.log(req.query)

    /* { signature: '3e3a5902b88be509d5d3e53e0b4a708b2399afc6' ,
    //微信的加密签名，结合你的token，timestamp和nonce经过某种算法生成的
  echostr: '6111278129223827167',//随机字符串，微信后台随机生成的
  timestamp: '1568618714',//时间戳，对应当前时间
  nonce: '1060563586' }//随机数，微信后台随机生成的 */

  const token = config.wechat.token

  const signature = req.query.signature
  const nonce = req.query.nonce
  const timestamp = req.query.timestamp
  const echostr = req.query.echostr


//1）将token、timestamp、nonce三个参数进行字典序排序 
//2）将三个参数字符串拼接成一个字符串进行sha1加密 
//3）开发者获得加密后的字符串可与signature对比，标识该请求来源于微信
  const str = [token, timestamp, nonce].sort().join('');

  const sha = sha1(str)

  if (sha === signature) {
    res.send(echostr)
  } else {
    res.send('wrong')
  }

});

app.listen(8888,()=>console.log('服务器启动成功'))
```





## 模态化

